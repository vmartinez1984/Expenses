@using Expenses.Core.Dtos
@model PeriodFullDto

@{
    ViewData["Title"] = "Periodos";
    decimal balance = 0;
    List<SubcategoryDto> subcategories = ViewBag.ListSubcategories2;
}

<div class="card">
    <div class="card-header">
        <div class="row">
            <div class="col">
                <h2 class="text-info">@Model.Name</h2>        
            </div>
            <div class="col">
                <div class="">
                    @await Html.PartialAsync("../Expenses/_create", ViewBag.ExpenseDto as ExpenseDto)
                </div>
            </div>
        </div>

        <div id="divTotal"></div>
    </div>
    <div class="card-body">

        <div class="accordion" id="accordionPanelsStayOpenExample">          
          <div class="accordion-item">
            <h2 class="accordion-header" id="panelsStayOpen-headingOne">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne">
                  <div class="row">
                      <div class="col-5">
                        Ingresos
                      </div>                      
                        <div class="col">
                        @Model.ListExpenses.Where(x=> x.CategoryName == "Ingresos").Sum(x=> x.Budget).ToString("c")
                    
                        @Model.ListExpenses.Where(x=> x.CategoryName == "Ingresos").Sum(x=> x.Amount).ToString("c")
                                @{
                                    decimal totalDeIngresos;
                                    totalDeIngresos = Model.ListExpenses.Where(x => x.CategoryName == "Ingresos").Sum(x => x.Amount);
                                }
                                @totalDeIngresos.ToString("c")
                    </div>
                  </div>
              </button>
            </h2>
            <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingOne">
              <div class="accordion-body">
                 @foreach (var item in Model.ListExpenses.Where(x=> x.CategoryName == "Ingresos"))
                 {
                    <div class="row border border-primary mt-1 p-1">

                        <div class="col-4 text-secondary">
                            <div class="row">                    
                                <div class="col">@Html.DisplayFor(modelItem => item.SubcategoryName)</div>                        
                
                                <div class="col">@Html.DisplayFor(modelItem => item.Name)</div>

                                <div class="col">@Html.DisplayFor(modelItem => item.DateRegister)</div>
                            </div>
                        </div>
                
                        <div class="col-2">@Html.DisplayFor(modelItem => item.Budget)</div>

                        @if (item.Amount == 0)
                        {
                            <div class="text-danger col-2">
                                @Html.DisplayFor(modelItem => item.Amount)
                            </div>
                        }
                        else
                        {
                            <div class="text-success col-2">
                                @Html.DisplayFor(modelItem => item.Amount)
                            </div>
                        }              

                        <div class="col-2 text-center">                
                            @if(item.Id == 0)
                            {                                 
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modelExpense" onclick="addExpense(@item.SubcategoryId)">
                                    Agregar
                                </button>
                            }
                            else
                            {                    
                                <button type="button" class="btn btn-warning text-white" data-bs-toggle="modal" data-bs-target="#modelExpense" onclick="editExpense(@item.Id)">
                                    Editar
                                </button>
                            }
                        </div>
                
                    </div>
                 }            
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="panelsStayOpen-headingTwo">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                <div class="row">
                      <div class="col-5">
                        Apartados
                      </div>                      
                      <div class="col">
                        @Model.ListExpenses.Where(x=> x.CategoryName == "Apartado").Sum(x=> x.Budget).ToString("c")
                      </div>
                      <div class="col">
                        @Model.ListExpenses.Where(x=> x.CategoryName == "Apartado").Sum(x=> x.Amount).ToString("c")
                      </div>
                      <div class="col">
                                @{
                                    decimal totalDeApartados;
                                    decimal total;
                                    totalDeApartados = Model.ListExpenses.Where(x => x.CategoryName == "Apartado").Sum(x => x.Budget) - Model.ListExpenses.Where(x => x.CategoryName == "Apartado").Sum(x => x.Amount);
                                    total = totalDeIngresos - Model.ListExpenses.Where(x=> x.CategoryName == "Apartado").Sum(x=> x.Amount);
                                }
                      @totalDeApartados.ToString("c")
                      <span class="text-info"> @total.ToString("c") </span>
                      </div>
                  </div>
              </button>
            </h2>
            <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingTwo">
              <div class="accordion-body">
                 @foreach (var item in Model.ListExpenses.Where(x=> x.CategoryName == "Apartado"))
                 {
                    <div class="row border border-primary mt-1 p-1">

                        <div class="col-4 text-secondary">
                            <div class="row">                               
                
                                <div class="col">@Html.DisplayFor(modelItem => item.SubcategoryName)</div>                        
                
                                <div class="col">@Html.DisplayFor(modelItem => item.Name)</div>

                                <div class="col">@Html.DisplayFor(modelItem => item.DateRegister)</div>
                            </div>
                        </div>
                
                        <div class="col-2">@Html.DisplayFor(modelItem => item.Budget)</div>

                        @if (item.Amount == 0)
                        {
                            <div class="text-danger col-2">
                                @Html.DisplayFor(modelItem => item.Amount)
                            </div>
                        }
                        else
                        {
                            <div class="text-success col-2">
                                @Html.DisplayFor(modelItem => item.Amount)
                            </div>
                        }
                
                        <div class="col-2">
                            @{
                                if (item.CategoryId == 2){
                                    balance +=  item.Amount;
                                }
                                else
                                {
                                    balance -=  item.Amount;                                    
                                }
                            }
                            @balance.ToString("C")
                        </div>


                        <div class="col-2 text-center">                
                            @if(item.Id == 0)
                            {                                 
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modelExpense" onclick="addExpense(@item.SubcategoryId)">
                                    Agregar
                                </button>
                            }
                            else
                            {                    
                                <button type="button" class="btn btn-warning text-white" data-bs-toggle="modal" data-bs-target="#modelExpense" onclick="editExpense(@item.Id)">
                                    Editar
                                </button>
                            }
                        </div>
                
                    </div>
                 }            
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="panelsStayOpen-headingThree">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
                  <div class="row">
                      <div class="col-5">
                        Gastos
                      </div>                      
                      <div class="col">
                        @Model.ListExpenses.Where(x=> x.CategoryName == "Gastos").Sum(x=> x.Budget).ToString("c")
                      </div>
                      <div class="col">
                        @Model.ListExpenses.Where(x=> x.CategoryName == "Gastos").Sum(x=> x.Amount).ToString("c")
                      </div>
                  </div>

              </button>
            </h2>
            <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingThree">
              <div class="accordion-body">
                 @foreach (var item in Model.ListExpenses.Where(x=> x.CategoryName == "Gastos"))
                 {
                    <div class="row border border-primary mt-1 p-1">

                        <div class="col-4 text-secondary">
                            <div class="row">                               
                
                                <div class="col">                                   
                                    @Html.DisplayFor(modelItem => item.SubcategoryName)</div>                        
                
                                <div class="col">@Html.DisplayFor(modelItem => item.Name)</div>

                                <div class="col">@Html.DisplayFor(modelItem => item.DateRegister)</div>
                            </div>
                        </div>
                
                        <div class="col-2">@Html.DisplayFor(modelItem => item.Budget)</div>

                        @if (item.Amount == 0)
                        {
                            <div class="text-danger col-2">
                                @Html.DisplayFor(modelItem => item.Amount)
                            </div>
                        }
                        else
                        {
                            <div class="text-success col-2">
                                @Html.DisplayFor(modelItem => item.Amount)
                            </div>
                        }
                
                        <div class="col-2">
                            @{
                                if (item.CategoryId == 2){
                                    balance +=  item.Amount;
                                }
                                else
                                {
                                    balance -=  item.Amount;                                    
                                }
                            }
                            @balance.ToString("C")
                        </div>


                        <div class="col-2 text-center">                
                            @if(item.Id == 0)
                            {                                 
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modelExpense" onclick="addExpense(@item.SubcategoryId)">
                                    Agregar
                                </button>
                            }
                            else
                            {                    
                                <button type="button" class="btn btn-warning text-white" data-bs-toggle="modal" data-bs-target="#modelExpense" onclick="editExpense(@item.Id)">
                                    Editar
                                </button>
                            }
                        </div>
                
                    </div>
                 }            
              </div>
              </div>
            </div>
          </div>
        </div>


                 
    </div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        var periodId = @Model.Id
        var subcategories = new Array()
        var total = 0

        @foreach (var item in subcategories)
        {
            <text>
            subcategories.push({Id : @item.Id, Name: '@item.Name', Amount : @item.Amount}) 
            </text>
        }

        function loadAmount(){            
            var subcategory
                        
            for(i=0; i < subcategories.length; i++){
                var subcategoryId

                subcategoryId = document.getElementById('SubcategoryId').value
                if(subcategories[i].Id == subcategoryId){
                    subcategory = subcategories[i]
                }
            }

            document.getElementById('Amount').value = subcategory.Amount;
        }

        function addExpense(subcategoryId){
            document.getElementById('SubcategoryId').value =subcategoryId
            document.getElementById('PeriodId').value = periodId
            document.getElementById('Id').value = 0
            loadAmount()
        }

        function editExpense(expenseId){
            url = '/api/expenses/'+expenseId

            fetch(url)
            .then(response => response.json())
            .then((response)=>{
                //console.log(response)
                setExpense(response)
            })
        }

        function setExpense(expense){
            document.getElementById('Id').value = expense.id
            document.getElementById('PeriodId').value = expense.periodId
            document.getElementById('SubcategoryId').value = expense.subcategoryId
            document.getElementById('Name').value = expense.name
            document.getElementById('Amount').value = expense.amount
        }

        function saveInApartN(){
            var subcategory 
            var subcategoryId

            subcategoryId = document.getElementById('SubcategoryId').value
            subcategory = subcategories.find(item => item.Id == subcategoryId)
            document.getElementById('Name').value = subcategory.Name

        }

        function sum(){
             var listChecks

             listChecks = document.getElementsByName('expense')
             total = 0             
             listChecks.forEach(check =>{
                 if(check.checked){
                     total +=parseFloat(check.value)
                 }
             })

             document.getElementById('divTotal').innerHTML = "$ " + total
        }
    </script>
}